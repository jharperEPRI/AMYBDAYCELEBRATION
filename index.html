
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  manifest.json
  <title>Birthday Quest ‚Äî Clue Unlocks</title>
  <style>
    :root { --primary:#007aff; --gray:#6b7280; --green:#10b981; --red:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto; color:#111; background:#fff; }
    header { padding:1rem; text-align:center; border-bottom:1px solid #eee; }
    header h1 { margin:.2rem 0; }
    header p { color:var(--gray); margin:.2rem 0 .6rem; }
    .progress { width:90%; max-width:680px; margin:.5rem auto 1rem; background:#f4f4f5; border-radius:999px; overflow:hidden; height:10px; }
    .bar { height:100%; background:linear-gradient(90deg, var(--primary), #34d399); width:0%; transition:width .4s; }
    main { max-width:820px; margin:0 auto; padding:1rem; }
    .card { border:1px solid #e5e7eb; border-radius:14px; padding:1rem; margin:.8rem 0; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .meta { font-size:.9rem; color:var(--gray); margin:.4rem 0; }
    .hint { color:var(--gray); font-style:italic; }
    .btn { background:var(--primary); color:#fff; border:none; border-radius:12px; padding:.6rem 1rem; font-weight:600; cursor:pointer; }
    .btn.secondary { background:#6d28d9; }
    .btn.ghost { background:#f4f4f5; color:#111; }
    .row { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    input[type="text"] { width:100%; max-width:420px; padding:.5rem .6rem; border:1px solid #d1d5db; border-radius:10px; }
    .task { display:flex; align-items:center; gap:.5rem; margin:.25rem 0; }
    .task input[type="checkbox"] { width:18px; height:18px; }
    .result { margin:.5rem 0; }
    .success { color:var(--green); font-weight:600; }
    .warn { color:var(--red); }
    .photo { width:100%; max-width:360px; margin:.4rem 0; border-radius:12px; display:none; }
    footer { text-align:center; color:var(--gray); padding:2rem 1rem; }
  </style>
</head>
<body>
<header>
  <h1>üéâ Birthday Quest ‚Äî Jan 10‚Äì11, 2026</h1>
  <p>Solve each clue to unlock the next destination. Some stops unlock by time and location.</p>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <p class="hint">Add to Home Screen for the full‚Äëscreen app experience.</p>
</header>

<main id="app"></main>
<footer>Made with ‚ù§Ô∏è by Jim & family</footer>

<script>
// =============================
// CONFIG: itinerary (sequential)
// =============================
const STOPS = [
  {
    id:"villagegrind",
    name:"The Village Grind ‚Äî Coffee Kickoff",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:120, // TODO: paste precise coords
    time:{ start:"2026-01-10T08:00:00-05:00", end:"2026-01-10T12:00:00-05:00" },
    clue:{
      type:"riddle",
      prompt:"Find a latte whose name evokes the sea. Enter the FIRST word of its name.",
      answers:["ocean"], // case-insensitive
    },
    tasks:["Order her favorite or a seasonal latte","Find a mural/art nearby and snap a photo","Cheers selfie"],
    maps:"https://maps.apple.com/?q=The%20Village%20Grind",
    requires:{ geofence:true, time:true, minChecks:2, photo:true }
  },
  {
    id:"morninggoat",
    name:"The Morning Goat ‚Äî Brunch/Lunch",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:150, // TODO
    time:{ start:"2026-01-10T10:00:00-05:00", end:"2026-01-10T14:00:00-05:00" },
    clue:{
      type:"finds",
      prompt:"Look & find: spot any GOAT reference (logo, art, menu). Check off three mini‚Äëtasks.",
      checklist:["Family table photo (no phones visible)","Photo of a goat reference","Pick a shared dish and rate it 1‚Äì5"]
    },
    tasks:[],
    maps:"https://maps.apple.com/?q=The%20Morning%20Goat",
    requires:{ geofence:true, time:true, minChecks:3, photo:true }
  },
  {
    id:"paintingtwist",
    name:"Painting with a Twist ‚Äî Canvas Session (1‚Äì3 PM)",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:120, // TODO
    time:{ start:"2026-01-10T12:50:00-05:00", end:"2026-01-10T15:10:00-05:00" },
    clue:{
      type:"riddle",
      prompt:"Unscramble this art word: <strong>RUBSH</strong>. Enter the correct word.",
      answers:["brush"]
    },
    tasks:["Group selfie with aprons","Hide a tiny heart in each painting","Photo of four canvases together"],
    maps:"https://maps.apple.com/?q=Painting%20With%20a%20Twist",
    requires:{ geofence:true, time:true, minChecks:2, photo:true }
  },
  {
    id:"swamprabbitcafe",
    name:"Swamp Rabbit Caf√© ‚Äî Snack & Trail",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:160, // TODO
    time:{ start:"2026-01-10T15:00:00-05:00", end:"2026-01-10T17:40:00-05:00" },
    clue:{
      type:"finds",
      prompt:"Trail tokens challenge: capture photos of (1) a bike bell, (2) a bridge/trestle, (3) a park sign.",
      checklist:["Rabbit logo selfie","Bike bell or bike close‚Äëup","Bridge/trestle or overlook","Park sign"]
    },
    tasks:["High‚Äëfive line on the trail"],
    maps:"https://maps.apple.com/?q=Swamp%20Rabbit%20Cafe%20and%20Grocery",
    requires:{ geofence:true, time:true, minChecks:3, photo:true }
  },
  {
    id:"hollowedearth",
    name:"Hollowed Earth Pottery ‚Äî Mug Making (6‚Äì7:30 PM)",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:120, // TODO
    time:{ start:"2026-01-10T17:45:00-05:00", end:"2026-01-10T19:45:00-05:00" },
    clue:{
      type:"riddle",
      prompt:"Clay on the wheel: the action that gets clay centered is called‚Ä¶ (enter one word).",
      answers:["wedging","center","centering"] // accept a few
    },
    tasks:["Wheel action shot for each person","Photo of chosen glaze colors","Group photo with mugs"],
    maps:"https://maps.apple.com/?q=Hollowed%20Earth%20Pottery",
    requires:{ geofence:true, time:true, minChecks:2, photo:true }
  },
  {
    id:"trio",
    name:"Trio ‚Äî Family Favorite Dinner",
    day:"2026-01-10",
    lat:null, lon:null, radius_m:150, // TODO
    time:{ start:"2026-01-10T19:30:00-05:00", end:"2026-01-10T22:30:00-05:00" },
    clue:{
      type:"riddle",
      prompt:"What heats the pizza here? Enter the material (hint: the restaurant‚Äôs name).",
      answers:["brick"]
    },
    tasks:["Table toast photo","Each shares a favorite moment (short video ok)","Dessert/last slice photo"],
    maps:"https://maps.apple.com/?q=Trio%20A%20Brick%20Oven%20Cafe",
    requires:{ geofence:true, time:false, minChecks:2, photo:true }
  },
  {
    id:"humane",
    name:"Greenville Humane Society ‚Äî Dog Walk (Sun 10:30 AM)",
    day:"2026-01-11",
    lat:null, lon:null, radius_m:150, // TODO
    time:{ start:"2026-01-11T10:00:00-05:00", end:"2026-01-11T12:00:00-05:00" },
    clue:{
      type:"riddle",
      prompt:"Your walking buddy‚Äôs name starts with which LETTER? Enter the first letter.",
      answers:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"] // accept any; you can refine later
    },
    tasks:["Photo with your pup & name tag","10‚Äësecond happy trot video","Group selfie + ‚Äòthank you‚Äô to the shelter"],
    maps:"https://maps.apple.com/?q=Greenville%20Humane%20Society",
    requires:{ geofence:true, time:true, minChecks:2, photo:true }
  }
];

// =============================
// STORAGE & UTILS
// =============================
const DBKEY = 'quest2026-seq';
const readDB = () => { try { return JSON.parse(localStorage.getItem(DBKEY))||{ idx:0, data:{} }; } catch(e){ return { idx:0, data:{} }; } };
const writeDB = (d) => localStorage.setItem(DBKEY, JSON.stringify(d));

const normalize = (s) => (s || '').toLowerCase().trim().replace(/[^\p{L}\p{N}]+/gu,'');
const inAnswers = (val, answers) => answers.map(a => normalize(a)).includes(normalize(val));

function distanceMeters(a, b) {
  const toRad = deg => deg * Math.PI/180, R=6371000;
  const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lon - a.lon);
  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
const withinWindow = (win) => {
  if(!win) return true;
  const now = new Date(), start=new Date(win.start), end=new Date(win.end);
  return now>=start && now<=end;
};
const fmt = (iso) => new Date(iso).toLocaleString([], { dateStyle:'medium', timeStyle:'short' });

// =============================
// RENDER CURRENT STOP ONLY
// =============================
function render() {
  const state = readDB();
  const app = document.getElementById('app');
  app.innerHTML = '';

  const total = STOPS.length;
  const completed = Object.values(state.data).filter(s => s?.unlocked).length;
  document.getElementById('bar').style.width = Math.round(completed/total*100)+'%';

  const idx = Math.min(state.idx, STOPS.length-1);
  const s = STOPS[idx];

  // Header card
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `
    <h2>${s.name}</h2>
    <p class="meta">${s.time ? `Time window: ${fmt(s.time.start)} ‚Äì ${fmt(s.time.end)} ‚Ä¢ ` : ''}${s.maps}Open in Maps</a></p>
    <p class="hint">${s.clue.prompt}</p>
    <div class="clue"></div>
    <div class="tasks"></div>
    <div class="row">
      <button class="btn" id="checkLoc">Check Location</button>
      <button class="btn secondary" id="addPhoto">Add Photo</button>
      <button class="btn ghost" id="saveProgress">Save Tasks</button>
    </div>
    <div class="result"></div>
    <img class="photo" id="photo" />
    <input type="file" id="file" accept="image/*" capture="environment" style="display:none" />
  `;
  app.appendChild(card);

  // Clue UI
  const clueBox = card.querySelector('.clue');
  let checks = [];
  if (s.clue.type === 'riddle') {
    clueBox.innerHTML = `
      <div class="row">
        <input type="text" id="answer" placeholder="Type answer‚Ä¶" />
        <button class="btn" id="submit">Submit</button>
      </div>
    `;
  } else if (s.clue.type === 'finds') {
    clueBox.innerHTML = `<p><strong>Check each item as you find it:</strong></p>`;
    s.clue.checklist.forEach((t, i) => {
      const row = document.createElement('div'); row.className='task';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id='chk'+i;
      cb.checked = !!readDB().data[s.id]?.checks?.[i];
      cb.addEventListener('change', () => { checks[i] = cb.checked; });
      const label = document.createElement('label'); label.textContent = t;
      row.appendChild(cb); row.appendChild(label); clueBox.appendChild(row);
    });
  }

  // Tasks UI (optional ‚Äúextras‚Äù to earn the unlock)
  const tasksBox = card.querySelector('.tasks');
  if (s.tasks?.length) {
    tasksBox.innerHTML = `<p><strong>Mini‚Äëtasks (optional but fun):</strong></p>`;
    s.tasks.forEach((t, i) => {
      const row = document.createElement('div'); row.className='task';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id='task'+i;
      cb.checked = !!readDB().data[s.id]?.tasks?.[i];
      cb.addEventListener('change', () => {
        const st = readDB(); st.data[s.id] = st.data[s.id] || {};
        (st.data[s.id].tasks ||= [])[i] = cb.checked; writeDB(st);
      });
      const label = document.createElement('label'); label.textContent = t;
      row.appendChild(cb); row.appendChild(label); tasksBox.appendChild(row);
    });
  }

  // Actions
  const result = card.querySelector('.result');
  const answerEl = card.querySelector('#answer');
  const submitBtn = card.querySelector('#submit');
  const checkLocBtn = card.querySelector('#checkLoc');
  const addPhotoBtn = card.querySelector('#addPhoto');
  const saveProgressBtn = card.querySelector('#saveProgress');
  const file = card.querySelector('#file');
  const photo = card.querySelector('#photo');

  // Submit riddle
  if (submitBtn) {
    submitBtn.addEventListener('click', () => {
      const val = answerEl?.value || '';
      if (!inAnswers(val, s.clue.answers)) {
        result.innerHTML = `<p class="warn">Not quite‚Äîtry again!</p>`;
      } else {
        const st = readDB(); st.data[s.id] = st.data[s.id] || {};
        st.data[s.id].riddleOK = true; writeDB(st);
        result.innerHTML = `<p class="success">Clue solved!</p>`;
        confetti();
      }
    });
  }

  // Save checklist progress (for "finds" type)
  if (saveProgressBtn && s.clue.type==='finds') {
    saveProgressBtn.addEventListener('click', () => {
      const st = readDB(); st.data[s.id] = st.data[s.id] || {};
      st.data[s.id].checks = checks;
      writeDB(st);
      result.innerHTML = `<p>Progress saved.</p>`;
    });
  }

  // Location check
  checkLocBtn.addEventListener('click', () => {
    if (!('geolocation' in navigator)) { result.innerHTML = `<p class="warn">Geolocation unavailable.</p>`; return; }
    if (s.lat == null || s.lon == null) { result.innerHTML = `<p class="warn">Coordinates missing for this stop.</p>`; return; }
    navigator.geolocation.getCurrentPosition(pos => {
      const me = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      const d = Math.round(distanceMeters(me, {lat:s.lat, lon:s.lon}));
      const timeOK = s.time ? withinWindow(s.time) : true;
      if (!timeOK) { result.innerHTML = `<p class="warn">Too early/late. Window: <b>${fmt(s.time.start)}</b>‚Äì<b>${fmt(s.time.end)}</b>.</p>`; return; }
      const st = readDB(); st.data[s.id] = st.data[s.id] || {};
      st.data[s.id].geoOK = d <= (s.radius_m || 120);
      writeDB(st);
      result.innerHTML = st.data[s.id].geoOK ? `<p class="success">On location! (~${d} m)</p>` : `<p>Keep going‚Ä¶ ~${d} m away.</p>`;
      if (st.data[s.id].geoOK) confetti();
    }, err => result.textContent = err.message, { enableHighAccuracy:true, timeout:12000 });
  });

  // Photo handling (as proof)
  addPhotoBtn.addEventListener('click', () => file.click());
  file.addEventListener('change', () => {
    const f = file.files[0]; if (!f) return;
    photo.src = URL.createObjectURL(f); photo.style.display='block';
    const st = readDB(); st.data[s.id] = st.data[s.id] || {};
    st.data[s.id].photo = true; writeDB(st);
    result.innerHTML = `<p>Photo added. üì∏</p>`;
  });

  // Unlock logic: tap card bottom to attempt advance
  const advanceBtn = document.createElement('button');
  advanceBtn.className='btn'; advanceBtn.textContent='Reveal Next Clue';
  advanceBtn.style.marginTop = '.6rem';
  advanceBtn.addEventListener('click', () => tryAdvance(s));
  card.appendChild(advanceBtn);
}

function tryAdvance(s){
  const st = readDB(); const sd = st.data[s.id] || {};
  // Minimum checklist items if any
  const checksDone = Array.isArray(sd.checks) ? sd.checks.filter(Boolean).length : 0;
  const tasksDone = Array.isArray(sd.tasks) ? sd.tasks.filter(Boolean).length : 0;

  const needRiddle = (s.clue.type==='riddle') ? !!sd.riddleOK : true;
  const needChecks = (s.clue.type==='finds') ? (checksDone >= (s.requires.minChecks||0)) : true;
  const needPhoto = s.requires.photo ? !!sd.photo : true;
  const needGeo   = s.requires.geofence ? !!sd.geoOK : true;
  const needTime  = s.requires.time ? withinWindow(s.time) : true;

  const ok = needRiddle && needChecks && needPhoto && needGeo && needTime;
  const app = document.getElementById('app');
  const msg = document.createElement('div'); msg.className='result';
  app.appendChild(msg);

  if (!ok) {
    const reasons = [];
    if (!needRiddle) reasons.push('solve the clue');
    if (!needChecks) reasons.push(`complete at least ${s.requires.minChecks} checklist items`);
    if (!needPhoto) reasons.push('add a photo');
    if (!needGeo) reasons.push('be at the location');
    if (!needTime) reasons.push('arrive during the time window');
    msg.innerHTML = `<p class="warn">Almost! Please ${reasons.join(', ')}.</p>`;
    return;
  }

  // Mark stop unlocked and advance
  st.data[s.id] = { ...sd, unlocked:true };
  const nextIdx = Math.min(readDB().idx + 1, STOPS.length-1);
  st.idx = nextIdx; writeDB(st);
  msg.innerHTML = `<p class="success">Unlocked! Next clue revealed.</p>`;
  confetti();
  setTimeout(render, 600);
}

function confetti(){
  for(let i=0;i<18;i++){
    const d=document.createElement('div');
    d.textContent='üéä'; d.style.position='fixed'; d.style.left=Math.random()*100+'%';
    d.style.top='-20px'; d.style.fontSize='20px'; d.style.transition='transform 1.2s ease, opacity 1.2s';
    document.body.appendChild(d);
    setTimeout(()=>{ d.style.transform=`translateY(${80+Math.random()*70}vh)`; d.style.opacity='0'; }, 10);
    setTimeout(()=> d.remove(), 1400);
  }
}

// Init
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
render();
</script>
</body>
</html>
